---
title: "Moodle Cleaning & Rename"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # Set WD to Root
library(tidyverse)

```


```{r}
tech_resp_df1_raw %>% names()
tech_grad_df2_raw %>% names()
```

## Needed Cols

-  Check Submission:

"Surname", "First name", "Email address", "State"      

-  Combine Responses:

"Surname", "First name", "Email address", "State",  "Response 1", "Response 2" ...

-  Combine MCQ:

"Surname", "First name", "Email address", "Started on", "Grade/10.00"  

-  MCQ Analysis: 

"Surname", "First name", "Email address", "Started on", "Grade/10.00", "Q" ... 


`force_numeric = TRUE`: Force format Grade and Q column to numeric

if dash "-" will convert to `NA`
if "Not yet graded" or "Requires grading" is presented will convert to `NA`


## General Cleaning


Also can choose to extract ID from Institution, department, or Email

```{r clean_moodle}
clean_moodle <- function(data, 
                         extract_id = TRUE, 
                         extract_id_from = c("Email address", 
                                             "Institution", "Department"),
                         id_regex = ".*", # Extract ID regex
                         sep_name = " ", # Separate First name and Surname
                         dash_na = TRUE, # Format Dash "-" to NA
                         force_numeric = TRUE # Force format Grade and Q column to numeric
                         ) {
  
  extract_id_from <- match.arg(extract_id_from)
  
  if(!is_report(data)) stop("This is not a moodle quiz report.", call. = F)
  
  q_max_no_df <- get_questions_no_max(data)
  resp_no <- get_responses_no(data)
  
  df_cleaned_1 <- data %>% 
    # Filter out "Overall average" in the last row of Grade report
    dplyr::filter(!is.na(`Email address`)) %>% 
    # Select Column that use in all type of Moodler Function
    dplyr::select(tidyselect::any_of(c("First name", "Surname", 
                                       "Institution", "Department",
                                       "Email address", "State", "Started on")),
                  # Select Grade column (if any)
                  tidyselect::starts_with("G"),
                  # Select Response column (if any)
                  tidyselect::starts_with("Response"),
                  # Select Q. column (if any)
                  tidyselect::matches("Q\\.")) %>% 
    tidyr::unite("First name", "Surname", col = "Name", sep = sep_name) %>% 
    dplyr::rename(Email = "Email address", Started ="Started on") 
   
  # Replace dash "-" with NA
  if(dash_na){
    df_cleaned_1 <- df_cleaned_1 %>% purrr::map_df(~dplyr::na_if(.x, "-"))
  }
  
  df_cleaned_1 <- df_cleaned_1 %>% 
    # Reformat Stated Date to POSIXct
    dplyr::mutate(Started = lubridate::dmy_hm(Started)) %>% 
    # Replace "/" at Grade/xx column
    dplyr::rename_with(.fn = ~str_replace(.x, "/", "_")) 
  
  # Format Grade column to numeric; Even if it's "Not yet graded" or dashed
  if(force_numeric){
  df_cleaned_1 <- df_cleaned_1 %>% 
    dplyr::mutate(
      dplyr::across(tidyselect::starts_with("G"), 
                    ~dplyr::na_if(.x, "Not yet graded")),
      dplyr::across(tidyselect::starts_with("G"), 
                    ~dplyr::na_if(.x, "-")),
      dplyr::across(tidyselect::starts_with("G"), as.numeric)
      )
  }  
  
  # If Grades Report, rename Q column and remove max
  if(is_grades_report(data)){
    
  df_cleaned_2 <- df_cleaned_1 %>% 
      dplyr::rename_with(.fn = ~paste0("Q", q_max_no_df$q_no), 
                     .cols =  tidyselect::starts_with("Q")) 
    if(force_numeric){
      # Format Q_xx column to numeric; Even if it's "Requires grading" or dashed
      df_cleaned_2 <- df_cleaned_2 %>% 
        dplyr::mutate(
          dplyr::across(tidyselect::starts_with("Q"), 
                        ~dplyr::na_if(.x, "Requires grading")),
          dplyr::across(tidyselect::starts_with("Q"), 
                        ~dplyr::na_if(.x, "-")),
          dplyr::across(tidyselect::starts_with("Q"), as.numeric)
          ) 
    }
  }
  # If Responses Report, rename R column
  if(is_responses_report(data)){
    
  df_cleaned_2 <- df_cleaned_1 %>% 
      dplyr::rename_with(.fn = ~paste0("Response_", resp_no), 
                     .cols =  tidyselect::starts_with("R"))
  }
  
  if(!extract_id) return(df_cleaned_2)
  # Extract Numeric ID from Email
  id_col_expr <- switch (extract_id_from,
    "Email address" = { dplyr::expr(Email) },
    "Institution" = { dplyr::expr(Institution) },
    "Department" = { dplyr::expr(Department) }
  )
  
  df_cleaned_2 %>% 
    dplyr::mutate(ID = as.character(stringr::str_extract(!!id_col_expr, id_regex)), 
                .keep = "unused", .after = Name)
  
}

tech_resp_df2_raw %>% clean_moodle(force_numeric = F, dash_na = F)
tech_resp_df1_raw %>% clean_moodle(force_numeric = T, dash_na = T)
int_nerv_resp %>% clean_moodle()
ncv_po_resp_raw %>% clean_moodle()

clean_moodle(tm_ncv_gr, extract_id_from = "Institution")
```

## Clean (Old Version)

```{r clean_moodle2}
clean_moodle2 <- function(data, 
                         extract_id = TRUE, id_regex = ".*", # Extract ID from Email
                         sep_name = " ", # Separate First name and Surname
                         dash_na = TRUE, # Format Dash "-" to NA
                         force_numeric = TRUE # Force format Grade and Q column to numeric
                         ) {
  
  if(!is_report(data)) stop("This is not a moodle quiz report.", call. = F)
  
  q_max_no_df <- get_questions_no_max(data)
  resp_no <- get_responses_no(data)
  
  df_cleaned_1 <- data %>% 
    # Filter out "Overall average" in the last row of Grade report
    dplyr::filter(!is.na(`Email address`)) %>% 
    # Select Column that use in all type of Moodler Function
    dplyr::select(tidyselect::all_of(c("First name", "Surname", 
                                       "Email address", "State", "Started on")),
                  # Select Grade column (if any)
                  tidyselect::starts_with("G"),
                  # Select Response column (if any)
                  tidyselect::starts_with("Response"),
                  # Select Q. column (if any)
                  tidyselect::matches("Q\\.")) %>% 
    tidyr::unite("First name", "Surname", col = "Name", sep = sep_name) %>% 
    dplyr::rename(Email = "Email address", Started ="Started on") 
   
  # Replace dash "-" with NA
  if(dash_na){
    df_cleaned_1 <- df_cleaned_1 %>% purrr::map_df(~dplyr::na_if(.x, "-"))
  }
  
  df_cleaned_1 <- df_cleaned_1 %>% 
    # Reformat Stated Date to POSIXct
    dplyr::mutate(Started = lubridate::dmy_hm(Started)) %>% 
    # Replace "/" at Grade/xx column
    dplyr::rename_with(.fn = ~str_replace(.x, "/", "_")) 
  
  # Format Grade column to numeric; Even if it's "Not yet graded" or dashed
  if(force_numeric){
  df_cleaned_1 <- df_cleaned_1 %>% 
    dplyr::mutate(
      dplyr::across(tidyselect::starts_with("G"), 
                    ~dplyr::na_if(.x, "Not yet graded")),
      dplyr::across(tidyselect::starts_with("G"), 
                    ~dplyr::na_if(.x, "-")),
      dplyr::across(tidyselect::starts_with("G"), as.numeric)
      )
  }  
  
  # If Grades Report, rename Q column and remove max
  if(is_grades_report(data)){
    
  df_cleaned_2 <- df_cleaned_1 %>% 
      dplyr::rename_with(.fn = ~paste0("Q", q_max_no_df$q_no), 
                     .cols =  tidyselect::starts_with("Q")) 
    if(force_numeric){
      # Format Q_xx column to numeric; Even if it's "Requires grading" or dashed
      df_cleaned_2 <- df_cleaned_2 %>% 
        dplyr::mutate(
          dplyr::across(tidyselect::starts_with("Q"), 
                        ~dplyr::na_if(.x, "Requires grading")),
          dplyr::across(tidyselect::starts_with("Q"), 
                        ~dplyr::na_if(.x, "-")),
          dplyr::across(tidyselect::starts_with("Q"), as.numeric)
          ) 
    }
  }
  # If Responses Report, rename R column
  if(is_responses_report(data)){
    
  df_cleaned_2 <- df_cleaned_1 %>% 
      dplyr::rename_with(.fn = ~paste0("Response_", resp_no), 
                     .cols =  tidyselect::starts_with("R"))
  }
  
  if(!extract_id) return(df_cleaned_2)
  # Extract Numeric ID from Email
  df_cleaned_2 %>% 
    dplyr::mutate(ID = as.character(stringr::str_extract(Email, id_regex)), 
                .keep = "unused", .after = Name)
  
}

tech_resp_df2_raw %>% clean_moodle(force_numeric = F, dash_na = F)
tech_resp_df1_raw %>% clean_moodle(force_numeric = T, dash_na = T)
int_nerv_resp %>% clean_moodle()
ncv_po_resp_raw %>% clean_moodle()

tm_mgrad_raw %>% moodleQuiz::clean_moodle(id_regex = "[:digit:]+")
```


                                             
```{r}
int_nerv_resp %>% get_questions_no_max()
int_nerv_resp %>% get_responses_no()

tech_grad_df2_raw%>% get_questions_no_max()
```
```{r}
int_nerv_resp %>% clean_moodle() %>% encode_moodle()
```


```{r}
tech_resp_df1_raw  %>% 
  distinct(across(c(starts_with("G"), starts_with("R"))))
```


### Message: NAs introduced by coercionNAs

Because some Grade are "Not yet Graded"
Because some Q are "Requires grading"

```{r}
c("A", "B") %>%  na_if(c("A","B"))
```


at function `as.numeric` at those cols

```{r}
tech_nograd_df1 %>% 
  distinct(across(c(starts_with("G"), starts_with("Q")))) %>% 
  mutate(across(starts_with("Q"), ~na_if(.x, "Requires grading")))
```



```{r}
tech_grad_df2_raw_clean <- tech_grad_df2_raw %>% clean_moodle()

tech_grad_df2_raw_clean 
```


# Rename

## Prefix/Suffix names of ls_df to multiple columns

```{r rename_with_ls_df_names}
rename_with_ls_df_names <- function(ls_df, 
                                    .cols,
                                    name_position = c("prefix", "suffix"),
                                    sep = "_"
                              ){
  
  name_position <- match.arg(name_position)
  nm <- names(ls_df)
  ls <- vector("list", length(ls_df))
  
  name_fun <- switch (name_position,
    "prefix" = { ~paste0(nm[[i]], sep ,.x)  },
    "suffix" = { ~paste0(.x, sep , nm[[i]]) }
  )

  for (i in seq_along(nm)) {
    
   ls[[i]] <- dplyr::rename_with(ls_df[[i]], .cols = {{.cols}}, name_fun)
    
  }

  names(ls) <- nm
  
  ls
  
}

tech_resp_ls_raw %>% 
  rename_with_ls_df_names(.cols = starts_with("R"), name_position = "p", sep = ": ") 
```


```{r}
tech_resp_ls_raw[[4]] %>% 
  rename_with(.cols = starts_with("R"), 
              
              ~paste0("Name1_", .x))
```



```{r}
tech_resp_ls_raw[[4]] %>% 
  rename_with(.cols = starts_with("R"), ~paste0("Name1_", .x))
```

## Vectorized naming of column names in list of DF 


```{r rename_with_ls_df}
rename_with_ls_df <- function(ls_df, .cols, 
                              new_names = names(ls_df) # Or character length = length(ls_df)
                              ){
  
  ls <- vector("list", length(ls_df))
    
  for(i in seq_along(ls_df)){
    ls[[i]] <- dplyr::rename_with(ls_df[[i]], .fn = ~new_names[[i]],  .cols = {{.cols}})
  }

  attributes(ls) <- attributes(ls_df)
  ls
}

tech_grad_ls_raw %>% 
  rename_with_ls_df(.cols = c("Surname"), new_names = paste0("n",1:3)) 
```






