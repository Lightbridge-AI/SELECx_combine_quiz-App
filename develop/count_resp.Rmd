---
title: "Count Responses"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # Set WD to Root
library(tidyverse)
library(testthat)
```

count_resp
count_resp.list
count_resp.data.frame

# Generic: Count Responses

```{r count_resp}
count_resp <- function(data,
                       # Clean
                       extract_id_from = c("Email address", 
                                           "Institution", "Department"),
                       id_regex = ".*", # Extract ID from Email
                       sep_name = " ", # Separate First name and Surname
                       # Encode
                       state = c("Finished", "In progress"),
                       encode = c(1,0),
                       choose_encode = c("max", "min", "all"),
                       choose_time = c("first", "last", "all"),
                       # TRUE = count individual parts of cloze responses
                       count_cloze_parts = F,
                       sep_col = "_" # To List method: `sep_col`
                       ) {
  
  UseMethod("count_resp")
  
}

count_resp(tech_resp_df1_raw, count_cloze_parts = T)
count_resp(tech_resp_ls_raw, count_cloze_parts = )
count_resp(tm_ncv_resp, extract_id_from = "Institution", count_cloze_parts = F)

moodleQuiz::count_resp(tech_resp_df1_raw)
```


# List method: Count Responses

extra arg from DF method: `sep_col`

```{r count_resp.list}
count_resp.list <- function(data,
                            # Clean
                            extract_id_from = c("Email address", 
                                             "Institution", "Department"),
                            id_regex = ".*", # Extract ID from Email
                            sep_name = " ", # Separate First name and Surname
                            # Encode
                            state = c("Finished", "In progress"),
                            encode = c(1,0),
                            choose_encode = c("max", "min", "all"),
                            choose_time = c("first", "last", "all"),
                            # TRUE = count individual parts of cloze responses
                            count_cloze_parts = F,
                            sep_col = "_"
                            ) {
  # Validate Responses report
  if(!is_named_list_data.frame(data)) stop("`data` must be named list of data.frame", call. = F)
  is_data_resp_rep <- purrr::every(data, is_responses_report)
  if(!is_data_resp_rep) stop("Elements of `data` must be Moodle Responses report",call. = F)
  # If want to count cloze parts, all element of `data` must have cloze 
  is_some_no_cloze <- purrr::some(data, ~!has_cloze_col(.x))
  if(count_cloze_parts && is_some_no_cloze) stop("Some elements of Moodle Responses report has no Cloze column to count", call. = F)
  
  # Total Responses Count
  tot_resp_count <- data %>% 
    purrr::map_int(~get_max_resp(.x, count_cloze_parts = count_cloze_parts)) %>% 
    sum()
  
  data %>% 
    purrr::map(
      ~count_resp.data.frame(.x, 
                             id_regex = id_regex, 
                             extract_id_from = extract_id_from, 
                             sep_name = sep_name, 
                             state = state, encode = encode, 
                             choose_encode = choose_encode, 
                             choose_time = choose_time,
                             count_cloze_parts = count_cloze_parts)
      ) %>% 
    purrr::map(~dplyr::select(.x, Name, ID, State, tidyselect::starts_with("C"))) %>% 
    # Prefix "State" and "Count" column name
    rename_with_ls_df_names(tidyselect::starts_with("S"), sep = sep_col) %>% 
    rename_with_ls_df_names(tidyselect::starts_with("C"), sep = sep_col) %>% 
    # Join
    purrr::reduce(dplyr::full_join, by = c("ID", "Name")) %>% 
    dplyr::rowwise() %>% 
    dplyr::mutate(
      "Total_{tot_resp_count}":= sum(dplyr::c_across(
        tidyselect::vars_select_helpers$where(is.numeric))
        )
      ) %>% 
    dplyr::ungroup()
  
  
}

tech_resp_ls_raw %>% count_resp.list(count_cloze_parts = T)
```

### Test: list method

```{r test count_resp.list}
test_that("count_resp.list",{
  
  some_no_cloze <- list(t = tech_resp_df1_raw,
                   k = tech_resp_df2_raw) %>%  map(~select(.x, !`Response 2`))
  
  count_resp.list(tech_resp_ls_raw, count_cloze_parts = T) %>% expect_s3_class("data.frame")
  count_resp.list(tech_resp_ls_raw, count_cloze_parts = F) %>% expect_s3_class("data.frame")
  
  # Error
  count_resp.list(tech_resp_df1_raw) %>% expect_error("must be named list of data.frame")
  count_resp.list(tech_grad_ls_raw) %>% expect_error("must be Moodle Responses")

  expect_error(count_resp.list(some_no_cloze, count_cloze_parts = T),
               "Some elements of Moodle Responses report has no Cloze column")
  
})
```

Error if some has no cloze column

```{r}
list(t = tech_resp_df1_raw, k = tech_resp_df2_raw) %>% 
  map(~select(.x, !`Response 2`)) %>% 
  count_resp.list(count_cloze_parts = T)
```


### Example

```{r}
tech_resp_count_tot <- tech_resp_ls_raw %>% 
  map_int(~get_max_resp(.x, count_cloze_parts = F)) %>% 
  sum()

tech_resp_ls_raw %>% 
  map(~count_resp.data.frame(.x, count_cloze_parts = F)) %>% 
  map(~select(.x, Name, ID, State, starts_with("C"))) %>% 
  rename_with_ls_df_names(starts_with("S")) %>% 
  rename_with_ls_df_names(starts_with("C")) %>% 
  
  reduce(full_join, by = c("ID", "Name")) %>% 
  
  rowwise() %>% 
  mutate("Total_{tech_resp_count_tot}" := sum(c_across(where(is.numeric)))) %>% 
  ungroup()
```



# DF method: Count Responses

Wrapper around `combine_resp.data.frame()` 
args are the same as that function except: 

No `part_glue` 

`count_cloze_parts` (instead of `split_cloze`)
-  `FALSE`: not count individual parts of cloze questions
-  `TRUE`: count individual parts of cloze questions


```{r count_resp.data.frame }
count_resp.data.frame <- function(data, 
                                  # Clean
                                  extract_id_from = c("Email address", 
                                             "Institution", "Department"),
                                  id_regex = ".*", # Extract ID from Email
                                  sep_name = " ", # Separate First name and Surname
                                  # Encode
                                  state = c("Finished", "In progress"),
                                  encode = c(1,0),
                                  choose_encode = c("max", "min", "all"),
                                  choose_time = c("first", "last", "all"),
                                  # TRUE = count individual parts of cloze responses
                                  count_cloze_parts = F,
                                  ...
                                    ) {
  
  if(!is_responses_report(data)) stop("`data` is not a Moodle Responses report.", call. = F)

  if(count_cloze_parts && !has_cloze_col(data)) stop("This Moodle Responses report has no Cloze column to count", call. = F)
  
  tot_len <- get_max_resp(data, count_cloze_parts = count_cloze_parts)
  
  data_comb <- data %>% 
    ### Passed to Combine Responses DF
    combine_resp.data.frame(split_cloze = count_cloze_parts,
                            extract_id_from = extract_id_from,
                            id_regex = id_regex, sep_name = sep_name, 
                            state = state, encode = encode, 
                            choose_encode = choose_encode, choose_time = choose_time
                            ) %>% 
    dplyr::mutate(
      dplyr::across(tidyselect::starts_with("R"), ~as.character(dplyr::na_if(.x, "-")))
      ) 
  
  data_comb %>% 
    dplyr::rowwise() %>% 
    dplyr::mutate(
      "Count_Resp_{tot_len}" := sum(!is.na(dplyr::c_across(tidyselect::starts_with("R"))))
      ) %>% 
    dplyr::ungroup() %>% 
    dplyr::select(!tidyselect::starts_with("R"))

    
}

tech_resp_df2_raw %>% count_resp.data.frame(count_cloze_parts = T)
tech_resp_df2_raw %>% count_resp.data.frame(count_cloze_parts = F)

ncv_po_resp_raw %>% count_resp.data.frame(count_cloze_parts = F)
```

### Test: DF

```{r test count_resp.data.frame}
test_that("count_resp.data.frame",{
  
  no_cloze <- tech_resp_df1_raw %>% select(!`Response 2`)
  
  count_resp.data.frame(tech_resp_df2_raw, 
                        count_cloze_parts = T) %>% expect_s3_class("data.frame")
  count_resp.data.frame(tech_resp_df2_raw, 
                        count_cloze_parts = F) %>% expect_s3_class("data.frame")
  # Error Msg
  count_resp.data.frame(tm_mgrad_raw) %>% expect_error("is not a Moodle Responses report.")
  count_resp.data.frame(no_cloze, 
                        count_cloze_parts = T) %>% 
    expect_error("has no Cloze column to count")
  
})
```

## Count Maximum Responses

```{r get_max_resp}
get_max_resp <- function(df_resp, count_cloze_parts = F) {
  
    # Length of all non-cloze response col
  noncloze_len <- length(get_noncloze_resp_colnm(df_resp))
  # Length of Cloze col
  cloze_len <- if(count_cloze_parts){
      # Sum of all cloze parts
      sum( get_cloze_attr(df_resp)$parts ) 
    }else{
      # Omit NA in case of `get_cloze_col_name` return NA if no cloze column
      get_cloze_col_names(df_resp) %>% length()
    }
  # Combine length
  tot_len <- noncloze_len + cloze_len
  tot_len
}

get_max_resp(tech_resp_df2_raw, count_cloze_parts = T)

get_max_resp(ncv_po_resp_raw)
```

```{r}
get_noncloze_resp_colnm
```


## Example: Count Responses of DF 

```{r}
# length of all responses column
tech_resp_df2_resp_len <- length(get_responses_no(tech_resp_df2_raw))

tech_resp_df2_raw %>% 
  combine_resp.data.frame() %>% 
  mutate(across(starts_with("R"), ~na_if(.x, "-"))) %>% 
  rowwise() %>% 
  mutate("Count_{tech_resp_df2_resp_len}" := sum(!is.na(c_across(starts_with("R"))))) %>% 
  ungroup() %>% 
  select(!starts_with("R"))
```

## Example: Count Responses of DF & individual Parts of Cloze

**Total Count = non-cloze Responses + all cloze parts**

```{r}
# Length of all non-cloze response col
tech_resp_df2_non_cloze_len <- length(get_noncloze_resp_colnm(tech_resp_df2_raw))
# Length of all cloze parts in every responses
tech_resp_df2_cloze_parts_len <- get_cloze_attr(tech_resp_df2_raw)$parts %>% sum()

df2_tot_count <- tech_resp_df2_non_cloze_len + tech_resp_df2_cloze_parts_len 

tech_resp_df2_raw %>% 
  combine_resp.data.frame(split_cloze = T) %>% 
  mutate(across(starts_with("R"), ~na_if(.x, "-"))) %>% 

  rowwise() %>% 
  mutate("Count_{df2_tot_count}" := sum(!is.na(c_across(starts_with("R"))))) %>% 
  ungroup() %>% 
  select(!starts_with("R"))
```





